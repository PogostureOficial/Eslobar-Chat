<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Eslobar</title>
  <link rel="stylesheet" href="/static/index.css">
  <link rel="stylesheet" href="/static/index_mobile.css" media="(max-width: 768px)">
  <link rel="stylesheet" href="index_mobile.css" id="theme-dark">
  <link rel="stylesheet" href="light.css" id="theme-light" disabled>
  <link rel="icon" type="image/png" href="/static/images/icon.png">
  <link rel="manifest" href="/static/manifest.json">
  <!-- Color de la barra del navegador en m√≥vil -->
  <meta name="theme-color" content="#ffffff">

  <!-- Otros meta opcionales para compatibilidad -->
  <meta name="msapplication-navbutton-color" content="#ffffff">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
</head>
<body>

  <!-- ====== Ventana de Bienvenida ====== -->
<div id="welcome-overlay">
  <div class="welcome-modal">
    <div class="progress-bar">
      <div class="progress" style="width: 33%;"></div>
    </div>

    <div id="step1" class="step active">
      <h2>Bienvenido a Eslobar</h2>
      <p>Antes de que puedas comenzar a usar Eslobar, hagamos algunos ajustes para personalizar su experiencia.</p>
      <button id="continue1">Continuar</button>
      <span class="step-count">1/5</span>
    </div>

      <div id="step2" class="step">
      <h2 class="welcome-title">Personalicemos tu experiencia</h2>
      <p class="welcome-subtitle">Dinos c√≥mo quieres que te llame la IA:</p>

      <div class="name-container fancy-input">
        <input 
          type="text" 
          id="userName" 
          placeholder="Escribe tu nombre aqu√≠..." 
          maxlength="20"
        >
        <span class="input-underline"></span>
      </div>

      <button id="continueBtn" class="continue-btn" disabled>Continuar</button>
      <span class="step-indicator">2/5</span>
    </div>


    <div id="step3" class="step">
      <h2>Elige el color de tus mensajes</h2>

      <!-- Mensaje de ejemplo -->
      <div id="colorPreview" class="message example-message">
        Expl√≠came la revoluci√≥n francesa
      </div>

      <!-- Opciones de color -->
      <div class="color-picker">
        <div class="color-option gray" data-color="gris" title="Gris (por defecto)"></div>
        <div class="color-option blue" data-color="azul" title="Azul"></div>
        <div class="color-option pink" data-color="rosa" title="Rosa"></div>
      </div>

      <button id="finish">Continuar</button>
      <span class="step-count">3/5</span>
    </div>

    <div id="step4" class="step">
      <h2>Sube tu foto de perfil</h2>
      <p>Elige una imagen para que te identifique en Eslobar.</p>

      <label for="profileImage" class="upload-area">
        <div class="upload-icon"> </div>
        <p>Haz clic aqu√≠ para subir tu foto</p>
        <input type="file" id="profileImage" accept="image/*" style="display: none;">
      </label>

      <div id="previewContainer" class="preview-container" style="display:none;">
        <img id="previewImage" class="preview-image" alt="Vista previa">
      </div>

      <button id="finishSetup" class="continue-btn" disabled>Continuar</button>
      <span class="step-indicator">4/5</span>
    </div>

    <div id="step5" class="step">
      <h2> Todo listo, <span id="finalName"></span>!</h2>
      <p>Has completado la configuraci√≥n inicial de Eslobar.</p>
      <button id="enterApp" class="continue-btn">Terminar</button>
      <span class="step-indicator">5/5</span>
    </div>
  </div>
</div>


<!-- üîπ Modal de confirmaci√≥n -->
<div id="logoutModal" class="logout-modal">
  <div class="logout-content">
    <h2>¬øSeguro que quieres cerrar sesi√≥n?</h2>
    <div class="logout-buttons">
      <button id="confirmLogout" class="logout-confirm">S√≠</button>
      <button id="cancelLogout" class="logout-cancel">Cancelar</button>
    </div>
  </div>
</div>
  
<!-- üîπ Barra lateral izquierda -->
<div class="sidebar">
  <div class="sidebar-logo">
  <img src="/static/images/logo.png" alt="Logo" />
</div>

  <div class="sidebar-section">Chats</div>

    <!-- ---- Pegar directamente ALTERNATIVO EN TU SIDEBAR: justo despu√©s de =========================================================================================================================================================
       <div class="sidebar-section">Chats</div> ---- -->
  <div id="chat-controls" style="display:flex;gap:8px;align-items:center;">
    <button id="newChatBtn" title="Nuevo chat" style="border:none;background:#2b2b2b;color:#fff;padding:8px 10px;border-radius:10px;cursor:pointer;">
      + Nuevo
    </button>
  </div>

  <!-- Contenedor donde aparecer√°n los chats guardados -->
  <div id="chatList" class="chat-list" style="display:flex;flex-direction:column;gap:8px;margin-top:8px;"></div>

  <!-- -----------------------------------------------------
       Instrucci√≥n: agregar este script AL FINAL del body (DESPU√âS
       de **todos** tus scripts existentes y justo antes de </body>):
       /static/chat-storage.js  (puedes poner el archivo en /static/)
     --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- -->
 


  <button id="installButton" style="display:none;">üì≤ Instalar aplicaci√≥n</button>

    <!-- üîπ Perfil del usuario -->
  <div class="user-info">
    <button id="profileButton" class="profile-button">
      <img id="userAvatarSidebar" src="/static/images/default-avatar.png" alt="Foto" class="sidebar-avatar">
      <span id="sidebarUserName">Usuario</span>
    </button>
  
    <div id="profileMenu" class="profile-menu">
      <div class="menu-item" id="openConfig">‚öôÔ∏è Configuraci√≥n</div>
      <div class="menu-item" id="logoutSidebar">üö™ Cerrar sesi√≥n</div>
    </div>
  </div>
</div> <!-- ‚Üê cerrar el div.sidebar -->

<div id="mobileOverlay" class="mobile-overlay" onclick="closeMobileSidebar()"></div>

<!-- üîπ Contenido principal -->
<div class="main-content">
  

  <!-- Barra superior -->
  <div class="top-bar">
    
    <!-- Men√∫ Eslobar -->
    <div class="menu-container">
      <div class="menu-header" onclick="toggleMenu()">
        <span class="menu-title">Eslobar</span>
        <img src="/static/images/arrow.png" alt="arrow" class="menu-arrow">
      </div>
      <div class="menu-dropdown" id="dropdownMenu">
        <div class="menu-item" data-plan="basic" onclick="selectVersion('basic')">
          <img src="/static/images/basic.png" alt="Eslobar B√°sico" class="menu-icon">
          <div class="menu-text">
            <div class="menu-title-version">Eslobar</div>
            <div class="menu-description">Versi√≥n b√°sica. Con l√≠mite de preguntas y pocas materias.</div>
          </div>
          <span class="checkmark">‚úî</span>
        </div>
        <div class="menu-item" data-plan="plus" onclick="selectVersion('plus')">
          <img src="/static/images/plus.png" alt="Eslobar Plus" class="menu-icon">
          <div class="menu-text">
            <div class="menu-title-version">Eslobar Plus (La m√°s comprada)</div>
            <div class="menu-description">Versi√≥n avanzada. Explicaciones detalladas, m√°s materias y sin l√≠mite.</div>
          </div>
          <span class="checkmark">‚úî</span>
        </div>
        <div class="menu-item" data-plan="pro" onclick="selectVersion('pro')">
          <img src="/static/images/pro.png" alt="Eslobar Pro" class="menu-icon">
          <div class="menu-text">
            <div class="menu-title-version">Eslobar Pro</div>
            <div class="menu-description">Herramientas profesionales y acceso a todas las materias.</div>
          </div>
          <span class="checkmark">‚úî</span>
        </div>
      </div>
    </div>

    <div class="mobile-header-left">
  <button id="mobileMenuBtn" class="mobile-hamburger" aria-label="Abrir men√∫">
    <span class="bar"></span>
    <span class="bar"></span>
    <span class="bar"></span>
  </button>
  <div class="menu-container mobile-visible">
  <div class="menu-header" onclick="toggleMenu()">
    <span class="menu-title">Eslobar</span>
    <img src="/static/images/arrow.png" alt="arrow" class="menu-arrow">
  </div>

  <div class="menu-dropdown" id="dropdownMenuMobile">
    <div class="menu-item" data-plan="basic" onclick="selectVersion('basic')">
      <img src="/static/images/basic.png" alt="Eslobar B√°sico" class="menu-icon">
      <div class="menu-text">
        <div class="menu-title-version">Eslobar</div>
        <div class="menu-description">Ideal para tareas sencillas.</div>
      </div>
      <span class="checkmark">‚úî</span>
    </div>

    <div class="menu-item" data-plan="plus" onclick="selectVersion('plus')">
      <img src="/static/images/plus.png" alt="Eslobar Plus" class="menu-icon">
      <div class="menu-text">
        <div class="menu-title-version">Eslobar Plus</div>
        <div class="menu-description">Para los pocos que quieren lucirse.</div>
      </div>
      <span class="checkmark">‚úî</span>
    </div>
  </div>
</div>

</div>


    <!-- Bot√≥n Mejorar a Plus -->
    <a href="static/plan.html" class="upgrade-btn">
      <img src="/static/images/plus1.png" alt="Plus" class="upgrade-icon"> 
      Obtener Eslobar
    </a>
  </div>

  

<div class="chat-container">
  <!-- T√≠tulo -->
  <div id="titulo"> </div>

  <!-- Contenedor del chat -->
  <div id="chat" class="chat-box"></div>

  <!-- Entrada de texto -->
  <div class="input-container" id="inputWrapper">
    <textarea 
      id="mensaje" 
      rows="1" 
      placeholder="Pregunta lo que quieras" 
      onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault();enviarMensaje()}"></textarea>

    <div class="voice-btn" id="voiceBtn" aria-hidden="true">
      <img src="/static/images/button1.png" id="btn1" class="initial-visible" alt="Micr√≥fono">
      <img src="/static/images/button2.png" id="btn2" class="initial-hidden" alt="Enviar">
    </div>

         <div class="plus-menu">
          <button id="plusBtn" class="plus-btn">
            <img src="/static/images/button5.png" alt="Abrir men√∫" class="plus-icon">
          </button>
          <div id="plusOptions" class="plus-options">
            <button id="predictBtn">üß† Predecir ex√°menes</button>
          </div>
        </div>

         <!-- Bot√≥n + y men√∫ -->
        <div class="plus-container">
          <button id="plus-btn" class="plus-btn">
            <img src="/static/images/button5.png" alt="Abrir men√∫" class="plus-icon">
        </button>

  <!-- Men√∫ principal -->
        <div id="plus-menu" class="plus-menu">
          <div class="menu-item" id="attach-files">Adjuntar archivos</div>
          <div class="menu-item" id="predict-exam">Predecir examen de:</div>
          <div class="menu-item" id="get-advice">Dame consejos para aprobar:</div>

          <!-- Submen√∫ -->
          <div id="submenu" class="submenu">
            <div class="submenu-item" data-text="Historia">Historia</div>
            <div class="submenu-item" data-text="Matem√°ticas">Matem√°ticas</div>
            <div class="submenu-item" data-text="Geograf√≠a">Geograf√≠a</div>
          </div>
        </div>
      </div>



   </div> <!-- Cierre de input-container -->

  <div class="eslobar-warning">
      Actualmente estas utilizando la prueba gratuita. Acaba el 30 de octubre.
    </div>

  </div>

  <!-- Info del plan -->
  <div class="plan-info">
    Actualmente est√°s utilizando el plan <strong>B√°sico</strong> de Eslobar. 
    <a href="" class="plan-link">Obtener m√°s informaci√≥n sobre los planes</a>
  </div>
</div>

<div id="configModal" class="config-modal">
  <div class="config-modal-content">
    <h2>‚öôÔ∏è Configuraci√≥n</h2>

    <label>Nombre</label>
    <input type="text" id="configName" placeholder="Tu nombre">

    <label>Color de mensajes</label>
    <div class="config-color-picker">
      <div class="config-color-option gray" data-color="gris"></div>
      <div class="config-color-option blue" data-color="azul"></div>
      <div class="config-color-option pink" data-color="rosa"></div>
    </div>

    <p>üìß Correo registrado: <span id="configEmail"></span></p>

    <button id="saveConfig" class="config-btn">Guardar cambios</button>
    <button id="closeConfig" class="config-btn">Cerrar</button>
  </div>
</div>


  <script>
  // Si no hay sesi√≥n, volver al login
  if (localStorage.getItem("sesion_activa") !== "true") {
    window.location.href = "index.html";
  }

  // Si hay sesi√≥n, mostrar los datos del usuario
  /*document.addEventListener("DOMContentLoaded", () => {
  const correo = localStorage.getItem("correo_usuario");
  const foto = localStorage.getItem("foto_usuario");

  const userEmailEl = document.getElementById("userEmail");
  const userAvatarEl = document.getElementById("userAvatar");

  if (correo) userEmailEl.textContent = correo;
  if (foto) userAvatarEl.src = foto;

  console.log("Usuario activo:", correo);
});*/
</script>


<!-- Archivo de configuraci√≥n: cambiar URL backend seg√∫n entorno -->
<script src="/static/config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <script>
  if (!localStorage.getItem("sesion_activa")) {
    window.location.href = "index.html";
  }
</script>

<!-- √öNICO BLOQUE JS (unificado y seguro) -->
<script>

  /* ====== Mobile sidebar & hamburger control ====== */
(function mobileSidebarSetup() {
  const mobileBtn = document.getElementById('mobileMenuBtn');
  const sidebar = document.querySelector('.sidebar');
  const overlay = document.getElementById('mobileOverlay');

  if (!mobileBtn || !sidebar || !overlay) return;

  // Abrir/cerrar
  function openMobileSidebar() {
    sidebar.classList.add('open');
    overlay.classList.add('visible');
    mobileBtn.classList.add('open');
    // bloquear scroll body
    document.body.style.overflow = 'hidden';
    // marcar items actuales
    if (typeof updateSelectedPlanUI === 'function') updateSelectedPlanUI();
  }
  window.openMobileSidebar = openMobileSidebar;

  function closeMobileSidebar() {
    sidebar.classList.remove('open');
    overlay.classList.remove('visible');
    mobileBtn.classList.remove('open');
    document.body.style.overflow = '';
  }
  window.closeMobileSidebar = closeMobileSidebar;

  mobileBtn.addEventListener('click', () => {
    if (sidebar.classList.contains('open')) closeMobileSidebar();
    else openMobileSidebar();
  });

  // Cerrar al redimensionar (si se pasa a desktop)
  window.addEventListener('resize', () => {
    if (window.innerWidth > 768) closeMobileSidebar();
  });

  // Touch swipe para cerrar (gesto simple)
  let touchStartX = null;
  let touchStartY = null;

  sidebar.addEventListener('touchstart', (e) => {
    if (!e.touches || e.touches.length === 0) return;
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
  }, {passive: true});

  sidebar.addEventListener('touchmove', (e) => {
    if (touchStartX === null) return;
    const dx = e.touches[0].clientX - touchStartX;
    const dy = e.touches[0].clientY - touchStartY;
    // ignorar verticales largas
    if (Math.abs(dy) > Math.abs(dx)) return;
    // si el usuario desliza a la izquierda con suficiente fuerza cerramos
    if (dx < -40) closeMobileSidebar();
  }, {passive: true});

  // Tambi√©n cerrar desde overlay click (ya pusiste onclick en overlay pero reforzamos)
  overlay.addEventListener('click', closeMobileSidebar);

  // Al seleccionar un plan en m√≥vil, actualizar UI (si se usa "data-plan")
  document.querySelectorAll('.mobile-plan-item').forEach(item => {
    item.addEventListener('click', () => {
      const plan = item.dataset.plan;
      if (plan && typeof selectVersion === 'function') selectVersion(plan);
      // marcar active visual
      document.querySelectorAll('.mobile-plan-item').forEach(i => i.classList.toggle('active', i === item));
      // cerrar sidebar
      closeMobileSidebar();
    });
  });

})();

document.addEventListener('DOMContentLoaded', function() {
  
  /* =========================================================
     VARIABLES GLOBALES
  ========================================================= */
  const input = document.getElementById('mensaje');
  const chat = document.getElementById("chat");
  const titulo = document.getElementById("titulo");
  const btn1 = document.getElementById('btn1'); // mic
  const btn2 = document.getElementById('btn2'); // enviar
  const inputWrapper = document.getElementById('inputWrapper');
  const menuArrow = document.querySelector('.menu-arrow');
  const dropdownMenu = document.getElementById('dropdownMenu');

  btn1.style.visibility = 'visible';
  btn2.style.visibility = 'hidden';

  if (!input || !chat || !titulo || !inputWrapper) {
    console.warn('elementos principales faltan en DOM');
    return;
  }

  let animBtn1 = null, animBtn2 = null;
  let previousHasText = false;
  const D = 250; // duraci√≥n animaciones
  const easing = 'cubic-bezier(.22,1,.36,1)';

  // BACKEND: usa CONFIG.BACKEND_URL si existe, si no -> '/ask'
  const BACKEND_URL = (typeof CONFIG !== 'undefined' && CONFIG.BACKEND_URL) ? CONFIG.BACKEND_URL : '/ask';

  /* =========================================================
     UTILIDADES
  ========================================================= */
  function parseBold(text) {
    return text.replace(/\*(.*?)\*/g, '<b>$1</b>');
  }

  function addBotMessage() {
    const botMsg = document.createElement("div");
    botMsg.className = "message bot";
    chat.appendChild(botMsg);
    return botMsg;
  }

  function typeWriterEffect(container, text = '', maxDuration = 5000) {
  return new Promise((resolve) => {
    if (!text) return resolve();
    const parsed = marked.parse(text);
    let i = 0;

    // Calculamos la velocidad para que nunca tarde m√°s de maxDuration
    const speed = Math.min(15, maxDuration / parsed.length);

    const interval = setInterval(() => {
      container.innerHTML = parsed.slice(0, i + 1);
      if (container.parentElement) {
        container.parentElement.scrollTop = container.parentElement.scrollHeight;
      }
      if (++i >= parsed.length) {
        clearInterval(interval);
        resolve();
      }
    }, speed);
  });
}


  /* =========================================================
     PLAN SELECTION MENU
  ========================================================= */
  let selectedPlan = localStorage.getItem('selectedPlan') || 'basic';

  function selectVersion(plan) {
    selectedPlan = plan;
    localStorage.setItem('selectedPlan', plan);
    updateSelectedPlanUI();
    // Cerrar men√∫ al seleccionar
    if (dropdownMenu) dropdownMenu.style.display = 'none';
  }

  function updateSelectedPlanUI() {
    const items = document.querySelectorAll('.menu-item');
    items.forEach(item => {
      if (item.dataset.plan === selectedPlan) item.classList.add('active');
      else item.classList.remove('active');
    });
  }
  updateSelectedPlanUI();

  /* =========================================================
     ANIMACIONES BOTONES
  ========================================================= */
  function cancelAnimsAndFreeze() {
    [btn1, btn2].forEach((btn, idx) => {
      let anim = idx === 0 ? animBtn1 : animBtn2;
      if (anim) {
        anim.cancel();
        if (idx === 0) animBtn1 = null; else animBtn2 = null;
        const cs = getComputedStyle(btn);
        btn.style.transform = cs.transform === 'none' ? 'scale(1)' : cs.transform;
        btn.style.opacity = cs.opacity;
      }
    });
  }

  function transitionToBtn2() {
    cancelAnimsAndFreeze();
    btn1.style.visibility = 'visible';
    animBtn1 = btn1.animate(
      [{ transform: 'scale(1)', opacity: 1 }, { transform: 'scale(0)', opacity: 0 }],
      { duration: D, easing, fill: 'forwards' }
    );
    animBtn1.onfinish = () => {
      btn1.style.visibility = 'hidden';
      btn2.style.visibility = 'visible';
      animBtn2 = btn2.animate(
        [{ transform: 'scale(0)', opacity: 0 }, { transform: 'scale(1)', opacity: 1 }],
        { duration: D, easing, fill: 'forwards' }
      );
    };
  }

  function transitionToBtn1() {
    cancelAnimsAndFreeze();
    btn2.style.visibility = 'visible';
    animBtn2 = btn2.animate(
      [{ transform: 'scale(1)', opacity: 1 }, { transform: 'scale(0)', opacity: 0 }],
      { duration: D, easing, fill: 'forwards' }
    );
    animBtn2.onfinish = () => {
      btn2.style.visibility = 'hidden';
      btn1.style.visibility = 'visible';
      animBtn1 = btn1.animate(
        [{ transform: 'scale(0)', opacity: 0 }, { transform: 'scale(1)', opacity: 1 }],
        { duration: D, easing, fill: 'forwards' }
      );
    };
  }

  /* =========================================================
     EVENTOS INPUT & BOTONES
  ========================================================= */
  input.addEventListener('input', () => {
    const hasText = input.value.trim() !== '';
    if (hasText && !previousHasText) transitionToBtn2();
    else if (!hasText && previousHasText) transitionToBtn1();
    previousHasText = hasText;
    input.style.height = "auto";
    input.style.height = input.scrollHeight + "px";
    document.querySelector(".input-container")
      .classList.toggle("expanded", input.scrollHeight > input.clientHeight);
  });

  btn2.addEventListener("click", enviarMensaje);

  /* =========================================================
     MENSAJES (ENVIAR)
  ========================================================= */
  async function enviarMensaje() {
    const userText = input.value.trim();
    const mensaje = document.getElementById("mensaje").value.trim();
    if (!userText) return;

    const chatContainer = document.querySelector(".chat-container");

  // Cuando se manda el primer mensaje
  if (!chatContainer.classList.contains("active")) {
    chatContainer.classList.add("active");
  }
    // ocultar t√≠tulo si hay mensaje
    titulo.style.opacity = 0;

    // mensaje usuario
    const userMsg = document.createElement("div");
    userMsg.className = "message user";
    userMsg.innerHTML = parseBold(userText);
    chat.appendChild(userMsg);

    // reset input
    input.value = "";
    input.style.height = "auto";
    transitionToBtn1();
    previousHasText = false;

    // loading
    const loadingMsg = document.createElement("div");
    loadingMsg.className = "message bot loading";
    loadingMsg.innerHTML = `<span></span>
      <video src="/static/videos/anim1.mp4" autoplay loop muted playsinline width="40"></video>`;
    chat.appendChild(loadingMsg);

    // recalc m√≥vil + scroll
    if (window.__mobileChatHelpers && window.__mobileChatHelpers.recalc) window.__mobileChatHelpers.recalc();
    else chat.scrollTop = chat.scrollHeight;

    // fetch al backend
    try {
      const resp = await fetch(BACKEND_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          message: userText,
          plan: selectedPlan
        })
      });

      const data = await resp.json();

      if (chat.contains(loadingMsg)) chat.removeChild(loadingMsg);
      if (window.__mobileChatHelpers && window.__mobileChatHelpers.recalc) window.__mobileChatHelpers.recalc();

      const botMsg = addBotMessage();
      await typeWriterEffect(botMsg, data.reply || "‚ö†Ô∏è Error: sin respuesta.", 15);

      // asegurar scroll y recalc
      if (window.__mobileChatHelpers && window.__mobileChatHelpers.scrollToBottom) window.__mobileChatHelpers.scrollToBottom();

    } catch (error) {
      if (chat.contains(loadingMsg)) chat.removeChild(loadingMsg);
      const botMsg = addBotMessage();
      await typeWriterEffect(botMsg, "‚ö†Ô∏è Error al conectar con el servidor.", 15);
      if (window.__mobileChatHelpers && window.__mobileChatHelpers.scrollToBottom) window.__mobileChatHelpers.scrollToBottom();
    }

    // devolver foco y recalcular (√∫til en m√≥viles)
    input.focus();
    if (window.__mobileChatHelpers && window.__mobileChatHelpers.recalc) {
      setTimeout(() => window.__mobileChatHelpers.recalc(), 120);
    }
  }
  
// üëâ agregar esto:
window.enviarMensaje = enviarMensaje;

  /* =========================================================
     MOBILE HELPER: visualViewport + bloqueo scroll body
  ========================================================= */
  /*
  (function mobileHelper() {
  const vv = window.visualViewport;
  const MIN_CHAT_HEIGHT = 120; // px

  function ajustarAlturaMovil() {
    const viewportHeight = (window.visualViewport && window.visualViewport.height) || window.innerHeight;
    const inputH = inputWrapper.offsetHeight || 64;
    const margin = 8;

    // Establecemos la altura √∫til del chat para que nunca quede debajo del input
    const usable = Math.max(MIN_CHAT_HEIGHT, Math.floor(viewportHeight - inputH - margin));
    chat.style.height = usable + 'px';
    chat.style.maxHeight = usable + 'px';
    chat.style.overflowY = 'auto';

    // Ajustar posici√≥n del chat respecto al input (en m√≥viles)
    // Ponemos bottom del chat en (input height + 18px) para mantener espacio
    if (window.innerWidth <= 768) {
      const bottomOffset = inputH + 18;
      chat.style.bottom = bottomOffset + 'px';
    } else {
      chat.style.bottom = '';
    }

    // detectar teclado por cambio de visualViewport (si existe)
    const fullWindowInner = window.innerHeight;
    const keyboardProbablyOpen = vv ? (viewportHeight < fullWindowInner - 100) : false;

    // s√≥lo togglear la clase; NO forzar overflow:hidden en body (evita bugs con el teclado)
    document.body.classList.toggle('keyboard-open', !!keyboardProbablyOpen);

    // titulo visible solo si no hay mensajes
    const hasMessages = !!chat.querySelector('.message');
    titulo.style.opacity = hasMessages ? '0' : '1';

    // mantener scroll abajo
    chat.scrollTop = chat.scrollHeight;
  }

  // listeners
  if (window.visualViewport) {
    window.visualViewport.addEventListener('resize', ajustarAlturaMovil, { passive: true });
    window.visualViewport.addEventListener('scroll', ajustarAlturaMovil, { passive: true });
  }
  window.addEventListener('resize', ajustarAlturaMovil);

  // auto-grow textarea
  function autoGrow() {
    input.style.height = 'auto';
    input.style.height = input.scrollHeight + 'px';
    ajustarAlturaMovil();
  }
  input.addEventListener('input', autoGrow);

  input.addEventListener('focus', () => {
    // recalcula r√°pido al enfocar para dejar espacio al teclado
    setTimeout(() => {
      autoGrow();
      ajustarAlturaMovil();
      input.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
    }, 80);
  });
  input.addEventListener('blur', () => {
    setTimeout(ajustarAlturaMovil, 80);
  });

  window.addEventListener('load', () => {
    autoGrow();
    ajustarAlturaMovil();
  });

  // helpers expuestos (mantener compatibilidad)
  window.__mobileChatHelpers = {
    recalc: ajustarAlturaMovil,
    scrollToBottom: () => { chat.scrollTop = chat.scrollHeight; }
  };
})();
*/
  /* =========================================================
     MENU TOGGLE (mantengo tu API)
  ========================================================= */
  window.toggleMenu = function() {
  // detectamos si estamos en m√≥vil o escritorio
  const isMobile = window.innerWidth <= 768;

  const menu = isMobile
    ? document.getElementById('dropdownMenuMobile')
    : document.getElementById('dropdownMenu');

  const arrow = document.querySelector('.menu-arrow');

  if (!menu) return;

  const showing = menu.style.display === 'block';
  menu.style.display = showing ? 'none' : 'block';
  if (arrow) arrow.style.transform = showing ? 'rotate(0deg)' : 'rotate(180deg)';
};


  document.addEventListener('click', function(e) {
    const menuContainer = document.querySelector('.menu-container');
    if (menuContainer && !menuContainer.contains(e.target)) {
      dropdownMenu.style.display = 'none';
      if (menuArrow) menuArrow.style.transform = 'rotate(0deg)';
    }
  });

  // Exponer selectVersion para los onclick inline existentes
  window.selectVersion = selectVersion;
});

 
</script>

   <script>
 document.addEventListener('DOMContentLoaded', () => {
   const chatContainer = document.querySelector('.chat-container');
   const inputContainer = document.querySelector('.input-container');

   if (!chatContainer || !inputContainer) return;

/* if (window.visualViewport) {
     const ajustarLayout = () => {
       const viewportHeight = window.visualViewport.height;
       const totalHeight = window.innerHeight;
       const tecladoHeight = totalHeight - viewportHeight;

       if (tecladoHeight > 0) {
         // El teclado est√° visible ‚Üí movemos el input hacia arriba
         inputContainer.style.transform = `translateY(-${tecladoHeight}px)`;
       } else {
         // El teclado se cerr√≥ ‚Üí volvemos al lugar original
         inputContainer.style.transform = 'translateY(0)';
       }

       // Mantenemos el scroll al fondo del chat
       chatContainer.scrollTop = chatContainer.scrollHeight;
     };

     // Escuchamos el cambio del viewport visual (cuando aparece/desaparece teclado)
     window.visualViewport.addEventListener('resize', ajustarLayout);
   }
*/
  
 });
 </script>

   <script>
   // Lista de t√≠tulos posibles
   const titulos = [
     "¬°Inicia tu progreso!",
     "¬øEn que puedo ayudarte?",
     "¬°Preg√∫ntame lo que quieras!",
     "Tu aliado estrategico",
     "¬°Empecemos algo incre√≠ble!"
   ];

   // Selecciona el elemento del t√≠tulo
   const tituloElement = document.getElementById("titulo");

   // Funci√≥n para elegir un t√≠tulo aleatorio
   function cambiarTitulo() {
     const indiceAleatorio = Math.floor(Math.random() * titulos.length);
     tituloElement.textContent = titulos[indiceAleatorio];
   }

   // Ejecutar cada vez que se carga la p√°gina
   window.addEventListener("load", cambiarTitulo);
 </script>

<script>
  const logoutBtnSidebar = document.getElementById("logoutBtnSidebar");
const logoutModal = document.getElementById("logoutModal");
const confirmLogout = document.getElementById("confirmLogout");
const cancelLogout = document.getElementById("cancelLogout");

if (logoutBtnSidebar) {
  logoutBtnSidebar.addEventListener("click", () => logoutModal.classList.add("show"));
}

confirmLogout.addEventListener("click", () => {
  localStorage.removeItem("sesion_activa");
  localStorage.removeItem("correo_usuario");
  localStorage.removeItem("foto_usuario");
  window.location.href = "/";
});

cancelLogout.addEventListener("click", () => logoutModal.classList.remove("show"));
window.addEventListener("click", (e) => {
  if (e.target === logoutModal) logoutModal.classList.remove("show");
});
  </script> <!-- ‚úÖ ac√° cerr√°s el primer script -->
  <script>
document.addEventListener('DOMContentLoaded', () => {
  const plusBtn = document.getElementById('plusBtn');
  const plusOptions = document.getElementById('plusOptions');
  const predictBtn = document.getElementById('predictBtn');

  // Mostrar / ocultar men√∫
  plusBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    plusOptions.style.display = plusOptions.style.display === 'flex' ? 'none' : 'flex';
  });

  // Cerrar al hacer clic fuera
  document.addEventListener('click', () => plusOptions.style.display = 'none');

  // Acci√≥n del bot√≥n "Predecir ex√°menes"
  predictBtn.addEventListener('click', () => {
    plusOptions.style.display = 'none';
    alert('üîÆ Funci√≥n de predicci√≥n de ex√°menes pr√≥ximamente disponible.');
    // Aqu√≠ podr√≠as llamar a tu funci√≥n real, por ejemplo:
    // predecirExamen();
  });
});
</script>

<script>
/* =========================================================
   üîß FIX POSICI√ìN INPUT EN M√ìVIL (teclado abierto)
   Mantiene el input-container fijo abajo sin moverse ni a la derecha
========================================================= */
(function fixMobileInputPosition() {
  const inputWrapper = document.getElementById("inputWrapper");
  const chat = document.getElementById("chat");
  const vv = window.visualViewport;

  if (!inputWrapper || !vv) return;

  function ajustarPosicion() {
    // Detecta si el teclado est√° abierto (viewport m√°s chico que innerHeight)
    const keyboardAbierto = vv.height < window.innerHeight - 100;

    // Corrige el desplazamiento horizontal causado por zoom o teclado
    function ajustarPosicion() {
  const keyboardAbierto = vv.height < window.innerHeight - 100;

  // Evitar corrimiento horizontal
  inputWrapper.style.left = "0";
  inputWrapper.style.width = "100vw";

  if (keyboardAbierto) {
    inputWrapper.style.position = "fixed";
    const offset = window.innerHeight - vv.height - vv.offsetTop;
    inputWrapper.style.bottom = Math.max(offset - 10, 0) + "px";
  } else {
    inputWrapper.style.position = "fixed";
    inputWrapper.style.bottom = "0";
  }

  chat.scrollTop = chat.scrollHeight;
}

    // Corrige posici√≥n vertical
    if (keyboardAbierto) {
      inputWrapper.style.position = "fixed";
      const offset = window.innerHeight - vv.height - vv.offsetTop;
inputWrapper.style.bottom = Math.max(offset - 10, 0) + "px";
    } else {
      inputWrapper.style.position = "fixed";
      inputWrapper.style.bottom = "0";
    }

    // Mantiene scroll del chat estable
    chat.scrollTop = chat.scrollHeight;
  }

  vv.addEventListener("resize", ajustarPosicion);
  vv.addEventListener("scroll", ajustarPosicion);
})();
</script>


  <button id="theme-toggle"> </button>

<script>
const darkLink = document.getElementById('theme-dark');
const lightLink = document.getElementById('theme-light');
const toggleBtn = document.getElementById('theme-toggle');

toggleBtn.style.position = 'fixed';
toggleBtn.style.top = '10px';
toggleBtn.style.right = '10px';
toggleBtn.style.zIndex = '2000';
toggleBtn.style.background = 'transparent';
toggleBtn.style.border = 'none';
toggleBtn.style.fontSize = '22px';
toggleBtn.style.cursor = 'pointer';
toggleBtn.style.color = '#fff';

let isDark = true;

toggleBtn.addEventListener('click', () => {
  isDark = !isDark;
  lightLink.disabled = isDark;
  toggleBtn.textContent = isDark ? ' ' : ' ';
  toggleBtn.style.color = isDark ? '#fff' : '#000';
});
</script>

<!-- Modal minimalista -->
<div id="modal" class="modal">
  <div class="modal-content">
    <p>Esta funci√≥n no est√° disponible actualmente,<br>estamos trabajando para implementarla.</p>
    <button id="close-modal">Entendido</button>
  </div>
</div>

  <script>
  const plusBtn = document.getElementById('plus-btn');
  const plusMenu = document.getElementById('plus-menu');
  const submenu = document.getElementById('submenu');
  const modal = document.getElementById('modal');
  const closeModal = document.getElementById('close-modal');
  const textarea = document.getElementById('mensaje');

  // Mostrar/ocultar men√∫ principal
  plusBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    plusMenu.style.display = plusMenu.style.display === 'flex' ? 'none' : 'flex';
    submenu.style.display = 'none';
  });

  // Submen√∫
  const getAdvice = document.getElementById('get-advice');
  getAdvice.addEventListener('mouseenter', () => submenu.style.display = 'flex');
  getAdvice.addEventListener('mouseleave', () => {
    setTimeout(() => submenu.style.display = 'none', 400);
  });

  // Modal de funciones no disponibles
  document.getElementById('attach-files').addEventListener('click', () => modal.style.display = 'flex');
  document.getElementById('predict-exam').addEventListener('click', () => modal.style.display = 'flex');
  closeModal.addEventListener('click', () => modal.style.display = 'none');

  // Submen√∫ materias
  document.querySelectorAll('.submenu-item').forEach(item => {
    item.addEventListener('click', () => {
      textarea.value = `Dame consejos para aprobar ${item.dataset.text}`;
      textarea.dispatchEvent(new Event('input'));
      submenu.style.display = 'none';
      plusMenu.style.display = 'none';
    });
  });

  // Cerrar men√∫ al hacer clic fuera
  document.addEventListener('click', (e) => {
    if (!plusMenu.contains(e.target) && !plusBtn.contains(e.target)) {
      plusMenu.style.display = 'none';
      submenu.style.display = 'none';
    }
  });
</script>

  <script>
/* =========================================================
   üì≤ INSTALACI√ìN DE LA APLICACI√ìN (PWA)
   Muestra el bot√≥n solo si el navegador permite instalar la app
   y ejecuta el evento de instalaci√≥n al presionarlo.
========================================================= */

let deferredPrompt; // Guardamos el evento para usarlo m√°s tarde
const installButton = document.getElementById("installButton");

// Espera al evento "beforeinstallprompt"
window.addEventListener("beforeinstallprompt", (event) => {
  // Evita que el navegador muestre el banner por defecto
  event.preventDefault();

  // Guarda el evento para usarlo m√°s tarde
  deferredPrompt = event;

  // Muestra el bot√≥n de instalar
  if (installButton) {
    installButton.style.display = "block";
  }
});

// Cuando el usuario hace clic en el bot√≥n "Instalar aplicaci√≥n"
if (installButton) {
  installButton.addEventListener("click", async () => {
    if (!deferredPrompt) return; // Si no hay evento guardado, no hacemos nada

    // Muestra el prompt de instalaci√≥n
    deferredPrompt.prompt();

    // Espera a que el usuario elija una opci√≥n
    const { outcome } = await deferredPrompt.userChoice;

    console.log("Resultado de instalaci√≥n:", outcome);
    // Si el usuario acepta, puedes ocultar el bot√≥n
    if (outcome === "accepted") {
      installButton.style.display = "none";
    }

    // Limpia el evento (solo puede usarse una vez)
    deferredPrompt = null;
  });
}

// Detectar si la app ya est√° instalada (para ocultar el bot√≥n)
window.addEventListener("appinstalled", () => {
  console.log("‚úÖ Aplicaci√≥n instalada correctamente");
  if (installButton) installButton.style.display = "none";
});

    if (installButton) {
  installButton.style.display = "block";
  installButton.classList.add("glow"); // ‚ú® Activa el pulso animado
}

</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const overlay = document.getElementById("welcome-overlay");
  const steps = document.querySelectorAll(".step");
  const continue1 = document.getElementById("continue1");
  const continueBtn = document.getElementById("continueBtn"); // ‚úÖ ID corregido
  const finish = document.getElementById("finish");
  const usernameInput = document.getElementById("userName"); // ‚úÖ ID corregido
  const colorOptions = document.querySelectorAll(".color-option");
  const previewMsg = document.getElementById("colorPreview");

  /*// ‚úÖ Si ya complet√≥ el setup, ocultar cartel
  if (localStorage.getItem("eslobarSetupDone") === "true") {
    overlay.style.display = "none";
    aplicarColorUsuario(); // aplicar color al cargar
    return;
  }
*/
  // ‚úÖ Paso 1 ‚Üí Paso 2
  if (continue1) {
    continue1.addEventListener("click", () => {
      steps[0].classList.remove("active");
      steps[1].classList.add("active");
    });
  }

  // ‚úÖ Activar bot√≥n "Continuar" al escribir nombre
  if (usernameInput && continueBtn) {
    usernameInput.addEventListener("input", () => {
      const hasText = usernameInput.value.trim().length >= 2;
      continueBtn.disabled = !hasText;
      continueBtn.classList.toggle("active", hasText);
    });
  }

  // ‚úÖ Paso 2 ‚Üí Paso 3
  if (continueBtn) {
    continueBtn.addEventListener("click", () => {
      localStorage.setItem("eslobarUsername", usernameInput.value.trim());
      steps[1].classList.remove("active");
      steps[2].classList.add("active");
    });
  }

  // ‚úÖ Seleccionar color y vista previa
  if (colorOptions.length > 0 && previewMsg) {
    colorOptions.forEach(opt => {
      opt.addEventListener("click", () => {
        colorOptions.forEach(o => o.classList.remove("selected"));
        opt.classList.add("selected");

        const color = opt.getAttribute("data-color");
        previewMsg.className = "message example-message " + color;
        localStorage.setItem("eslobarColor", color);
      });
    });
  }

      // ‚úÖ Seleccionar gris por defecto al cargar el paso 3
    const defaultColor = "gris";
    localStorage.setItem("eslobarColor", defaultColor);
    previewMsg.classList.add(defaultColor);
    document.querySelector('.color-option.gray').classList.add('selected');


  // ‚úÖ Terminar bienvenida
  if (finish) {
  finish.addEventListener("click", () => {
    steps[2].classList.remove("active"); // paso 3 ‚Üí 4
    steps[3].classList.add("active");
  });
}


   // ‚úÖ DESPU√âS: las hacemos globales
  window.obtenerColor = function(nombre) {
    switch (nombre) {
      case "azul": return "#007bff";
      case "rosa": return "#ff4da6";
      default: return "#3a3a3a";
    }
  };

  window.aplicarColorUsuario = function() {
    const color = localStorage.getItem("eslobarColor") || "gris";
    document.documentElement.style.setProperty("--user-msg-bg", window.obtenerColor(color));
  };

  // ‚úÖ Aplicar el color cuando se carga la p√°gina
  window.aplicarColorUsuario();
});
</script>


<script src="/static/chat-storage.js"></script>

<script>
  const profileInput = document.getElementById("profileImage");
const previewImage = document.getElementById("previewImage");
const previewContainer = document.getElementById("previewContainer");
const finishSetup = document.getElementById("finishSetup");

if (profileInput) {
  profileInput.addEventListener("change", function () {
    const file = this.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function (e) {
        previewImage.src = e.target.result;
        previewContainer.style.display = "block";
        localStorage.setItem("eslobarAvatar", e.target.result);
        finishSetup.disabled = false;
      };
      reader.readAsDataURL(file);
    }
  });
}

</script>

<script>

  finishSetup.addEventListener("click", () => {
    const steps = document.querySelectorAll(".step"); // ‚úÖ volver a definirlo aqu√≠
    steps[3].classList.remove("active");
    steps[4].classList.add("active");

    document.getElementById("finalName").textContent = localStorage.getItem("eslobarUsername");
    document.getElementById("summaryName").textContent = localStorage.getItem("eslobarUsername");
    document.getElementById("summaryColor").textContent = localStorage.getItem("eslobarColor");
  });

document.getElementById("enterApp").addEventListener("click", () => {
  localStorage.setItem("eslobarSetupDone", "true");
  const overlay = document.getElementById("welcome-overlay"); // ‚úÖ redefinir aqu√≠
  overlay.remove();
  aplicarColorUsuario();
  actualizarSidebar();
});

</script>

  <script>

    function actualizarSidebar() {
  const name = localStorage.getItem("eslobarUsername");
  const avatar = localStorage.getItem("eslobarAvatar");
  if (name) document.getElementById("sidebarUserName").textContent = name;
  if (avatar) document.getElementById("userAvatarSidebar").src = avatar;
}

document.getElementById("profileButton").addEventListener("click", () => {
  document.getElementById("profileMenu").classList.toggle("show");
});

  </script>

  <script>

    document.getElementById("openConfig").addEventListener("click", () => {
  document.getElementById("configModal").style.display = "flex";
  document.getElementById("configName").value = localStorage.getItem("eslobarUsername");
  document.getElementById("configEmail").textContent = localStorage.getItem("correo_usuario") || "No disponible";
});

document.getElementById("closeConfig").addEventListener("click", () => {
  document.getElementById("configModal").style.display = "none";
});

document.getElementById("saveConfig").addEventListener("click", () => {
  const newName = document.getElementById("configName").value.trim();
  if (newName) localStorage.setItem("eslobarUsername", newName);

  const selectedColor = document.querySelector(".config-color-option.selected")?.getAttribute("data-color");
  if (selectedColor) localStorage.setItem("eslobarColor", selectedColor);

  aplicarColorUsuario();
  actualizarSidebar();
  document.getElementById("configModal").style.display = "none";
});

  </script>
</body>
</html>
















