<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Iniciar Sesión</title>

<link rel="shortcut icon" href="logo.png" type="image/png">

<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<style>
  :root{
    --bg: #1b1b1b;
    --panel: #1f1f1f;
    --muted: #6f6f6f;
    --accent-border: #2f2f2f;
    --btn-bg: #252525;
    --white: #ffffff;
    --radius: 999px;
    --w: 360px;
  }

  html,body{ height:100%; }
  body{
    margin:0;
    padding:0;
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    background: var(--bg);
    color: var(--white);
    font-family: Inter, "Segoe UI", Roboto, system-ui, -apple-system, "Helvetica Neue", Arial;
  }

  .logo {
    position: absolute;
    left: 28px;
    top: 22px;
    font-weight:700;
    font-size:18px;
    color: #fff;
    letter-spacing: 0.2px;
  }

  .wrap {
    width: min(92vw, var(--w));
    display:flex;
    flex-direction:column;
    align-items:center;
    gap: 18px;
    padding: 6px 0 40px;
  }

  h1 {
    margin: 0;
    margin-top: -10px;
    font-size: clamp(26px, 6vw, 48px);
    letter-spacing: 2px;
    font-weight: 700;
    text-transform: uppercase;
    text-align:center;
  }

  .buttons {
    width: 100%;
    display:flex;
    flex-direction:column;
    gap: 14px;
    margin-top: 6px;
    align-items:center;
  }

  .btn {
    width: 100%;
    max-width: 360px;
    background: var(--btn-bg);
    border: 1px solid var(--accent-border);
    box-shadow: 0 1px 0 rgba(255,255,255,0.01) inset;
    color: var(--white);
    padding: 14px 18px;
    border-radius: 999px;
    display:flex;
    align-items:center;
    gap: 14px;
    justify-content:flex-start;
    cursor:pointer;
    transition: transform .12s ease, background .12s ease, border-color .12s ease;
    font-size: 15px;
  }

  .btn:hover { transform: translateY(-3px); background: #2a2a2a; border-color: #3a3a3a; }
  .btn:active { transform: translateY(0); }

  .btn .ico {
    width: 36px;
    height: 36px;
    min-width:36px;
    min-height:36px;
    display:inline-flex;
    border-radius: 999px;
    align-items:center;
    justify-content:center;
    overflow:hidden;
  }

  .btn .ico img {
    width: 22px;
    height: 22px;
    display:block;
    object-fit:cover;
  }

  .btn .txt { flex:1; text-align:center; margin-left: -36px; } /* center text visually */

  .divider {
    width: 100%;
    height: 1px;
    background: #292929;
    margin: 8px 0 8px;
  }

  footer {
    position:absolute;
    bottom:12px;
    left:0;
    right:0;
    text-align:center;
    color: #474747;
    font-size: 13px;
  }

  /* Modales */
  .modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 60;
    backdrop-filter: blur(4px);
  }

  .modal {
    background: #141414;
    border-radius: 14px;
    padding: 22px 26px;
    width: min(92vw, 440px);
    max-width: 92%;
    color: #fff;
    box-shadow: 0 8px 30px rgba(0,0,0,0.6);
    text-align:center;
  }

  .modal h2 {
    margin:0 0 8px;
    font-size: 20px;
    font-weight:600;
  }

  .modal p { margin:0 0 18px; color: var(--muted); font-size:14px; }

  .modal .actions { display:flex; gap:10px; justify-content:center; }

  .btn-white {
    background:#fff;
    color:#000;
    border-radius:999px;
    padding:10px 18px;
    border:none;
    font-weight:700;
    cursor:pointer;
  }

  /* Email input inside modal */
  .email-input {
    width:100%;
    display:flex;
    gap:8px;
    margin-bottom: 8px;
    justify-content:center;
  }

  .email-input input[type="email"]{
    flex:1;
    background:#171717;
    border:1px solid #2f2f2f;
    padding:10px 12px;
    border-radius: 10px;
    color:#fff;
    outline:none;
  }

  .send-code {
    background: #fff;
    color: #000;
    border-radius: 10px;
    padding: 10px 14px;
    border:none;
    cursor:pointer;
    font-weight:700;
  }

  /* Hidden GSI container (we render button but keep hidden) */
  #gsi-hidden { display:none; }

  @media (max-width:380px){
    :root{ --w: 320px; }
  }
</style>
</head>
<body>

  <div class="logo">Eslobar</div>

  <div class="wrap">
    <h1>INICIA SESION</h1>

    <div class="buttons">
      <!-- Google custom-styled button -->
      <button class="btn" id="googleCustom">
        <span class="ico"><img src="static/google.png" alt="Google"></span>
        <span class="txt">Continuar con Google</span>
      </button>

      <!-- Apple -->
      <button class="btn" id="appleBtn">
        <span class="ico"><img src="static/apple.png" alt="Apple"></span>
        <span class="txt">Continuar con Apple</span>
      </button>

      <!-- Microsoft -->
      <button class="btn" id="microsoftBtn">
        <span class="ico"><img src="static/microsoft.png" alt="Microsoft"></span>
        <span class="txt">Continuar con Microsoft</span>
      </button>

      <div class="divider" aria-hidden="true"></div>

      <!-- Correo -->
      <button class="btn" id="correoBtn">
        <span class="ico"><img src="static/corre.png" alt="Correo"></span>
        <span class="txt">Continuar con correo . . .</span>
      </button>
    </div>
  </div>

  <footer>Al iniciar sesión en nuestra página, aceptas nuestros Términos y condiciones</footer>

  <!-- Hidden container to let GSI render internally if needed -->
  <div id="gsi-hidden"></div>

  <!-- Modal: servicio no disponible -->
  <div class="modal-backdrop" id="modalUnavailable">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="unavTitle">
      <h2 id="unavTitle">Servicio no disponible actualmente</h2>
      <p>Estamos trabajando para habilitar este método de inicio de sesión. Disculpá las molestias.</p>
      <div class="actions">
        <button class="btn-white" onclick="closeUnavailable()">Aceptar</button>
      </div>
    </div>
  </div>

  <!-- Modal: correo (ingresar email) -->
  <div class="modal-backdrop" id="modalEmail">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="emailTitle">
      <h2 id="emailTitle">Iniciar con correo</h2>
      <p>Introduce tu correo y te enviaremos un código de verificación.</p>

      <div class="email-input">
        <input id="modalEmailInput" type="email" placeholder="tucorreo@ejemplo.com" autocomplete="email" />
        <button class="send-code" id="modalSendBtn">Enviar</button>
      </div>

      <div class="actions">
        <button class="btn-white" onclick="closeModalEmail()">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal: mensaje de estado / error -->
  <div class="modal-backdrop" id="modalStatus">
    <div class="modal">
      <h2 id="statusTitle">Listo</h2>
      <p id="statusText">Se ha enviado el código.</p>
      <div class="actions">
        <button class="btn-white" onclick="closeStatus()">Aceptar</button>
      </div>
    </div>
  </div>

<script>
  /* --------- Configuración EmailJS (usa la clave que tenías) ---------- */
  try {
    emailjs.init("Ze_UcmuGqxNN8zCoU");
  } catch(e){
    console.warn("EmailJS init fallo", e);
  }

  /* ---------- Helpers modales ---------- */
  function showModal(id){
    const el = document.getElementById(id);
    if(el) el.style.display = "flex";
  }
  function hideModal(id){
    const el = document.getElementById(id);
    if(el) el.style.display = "none";
  }
  function closeUnavailable(){ hideModal('modalUnavailable'); }
  function closeModalEmail(){ hideModal('modalEmail'); }
  function closeStatus(){ hideModal('modalStatus'); }

  /* ---------- Servicio no disponible (Apple / Microsoft) ---------- */
  document.getElementById("appleBtn").addEventListener("click", (e) => {
    e.preventDefault();
    showModal('modalUnavailable');
  });
  document.getElementById("microsoftBtn").addEventListener("click", (e) => {
    e.preventDefault();
    showModal('modalUnavailable');
  });

  /* ---------- Inicio con correo: abrir modal ---------- */
  document.getElementById("correoBtn").addEventListener("click", (e) => {
    e.preventDefault();
    document.getElementById('modalEmailInput').value = "";
    showModal('modalEmail');
    setTimeout(()=> document.getElementById('modalEmailInput').focus(), 120);
  });

  /* ---------- Envío de código por correo (EmailJS) ---------- */
  document.getElementById("modalSendBtn").addEventListener("click", async () => {
    const input = document.getElementById('modalEmailInput');
    const email = (input.value || "").trim();
    if(!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){
      showStatus("Error", "Por favor ingresá un correo válido.");
      return;
    }
    // Generar código de 6 dígitos
    const codigo = Math.floor(100000 + Math.random() * 900000);
    // Guardar en localStorage para la verificación
    localStorage.setItem("codigo_verificacion", String(codigo));
    localStorage.setItem("correo_usuario", email);

    // payload para EmailJS (ajustar keys si tu template usa otros nombres)
    const payload = {
      email: email,
      codigo: String(codigo),
      time: new Date(Date.now() + 15*60000).toLocaleTimeString()
    };

    // Mostrar loading mínimo (cambiamos texto del botón)
    const sendBtn = document.getElementById('modalSendBtn');
    const prev = sendBtn.innerText;
    sendBtn.innerText = "Enviando...";
    sendBtn.disabled = true;

    try {
      await emailjs.send("service_nwp6u6j", "template_l73amke", payload);
      // cerrar modal y redirigir a verificación
      hideModal('modalEmail');
      // opcional: marcar sesión temporalmente? no, esperamos verificación
      // Mostrar status rápido
      showStatus("Código enviado", "Revisá tu bandeja de entrada. Serás redirigido a verificar.");
      setTimeout(()=> window.location.href = "/verificacion.html", 1200);
    } catch(err){
      console.error("EmailJS error:", err);
      showStatus("Error al enviar", "No pudimos enviar el correo. Intentá nuevamente más tarde.");
    } finally {
      sendBtn.innerText = prev;
      sendBtn.disabled = false;
    }
  });

  /* ---------- Status modal helper ---------- */
  function showStatus(title, text){
    const t = document.getElementById('statusTitle');
    const st = document.getElementById('statusText');
    t.innerText = title;
    st.innerText = text;
    showModal('modalStatus');
  }

  /* ---------------- Google Sign-In (GSI) ---------------- */
  // Mantener el mismo cliente que ya tenías.
  const GOOGLE_CLIENT_ID = "681954592440-8435k741g9o7tcfluuvqhkkdr6fulgnv.apps.googleusercontent.com";

  function parseJwt(token){
    try{
      var base64Url = token.split('.')[1];
      var base64 = base64Url.replace(/-/g,'+').replace(/_/g,'/');
      var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c){
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    }catch(e){
      return {};
    }
  }

  async function handleCredentialResponse(response) {
    try {
      if(!response || !response.credential) throw new Error("No credential");
      const info = parseJwt(response.credential);
      const correo = info.email || "";
      const foto = info.picture || "";

      // Guardar datos en localStorage (como tenías)
      localStorage.setItem("correo_usuario", correo);
      localStorage.setItem("foto_usuario", foto);
      localStorage.setItem("sesion_activa", "true");

      // Generar código y guardar
      const codigo = Math.floor(100000 + Math.random() * 900000);
      localStorage.setItem("codigo_verificacion", String(codigo));

      // Enviar por EmailJS (para que el usuario reciba el código)
      const payload = {
        email: correo,
        codigo: String(codigo),
        time: new Date(Date.now() + 15*60000).toLocaleTimeString()
      };

      await emailjs.send("service_nwp6u6j", "template_l73amke", payload);

      // Redirigir a verificacion
      window.location.href = "/verificacion.html";
    } catch (err) {
      console.error("Google sign-in error:", err);
      showStatus("Error", "No se pudo completar la autenticación con Google.");
    }
  }

  // Inicializar GSI cuando esté disponible
  function initGSI() {
    try {
      if(window.google && google.accounts && google.accounts.id){
        google.accounts.id.initialize({
          client_id: GOOGLE_CLIENT_ID,
          callback: handleCredentialResponse
        });
        // Render en un contenedor oculto para que la librería quede lista.
        google.accounts.id.renderButton(
          document.getElementById("gsi-hidden"),
          { theme: "outline", size: "large", text: "signin_with", shape: "rectangular", logo_alignment: "left" }
        );
        google.accounts.id.disableAutoSelect();
      } else {
        console.warn("GSI no disponible (aún).");
      }
    } catch(e){
      console.warn("Inicialización GSI error:", e);
    }
  }

  // Esperar a que la librería GSI cargue (si no lo hizo en 'load')
  window.addEventListener('load', () => {
    // Si ya hay sesión activa, redirigir a home
    if(localStorage.getItem("sesion_activa") === "true"){
      window.location.href = "/home.html";
      return;
    }
    // Intenta inicializar GSI. Si la librería se carga un poco después, reintenta brevemente.
    initGSI();
    // reintentos suaves por 2s
    let tries = 0;
    const tryInterval = setInterval(()=>{
      tries++;
      if(window.google && google.accounts && google.accounts.id){
        initGSI();
        clearInterval(tryInterval);
      } else if(tries > 10){
        clearInterval(tryInterval);
      }
    }, 200);
  });

  // Al hacer click en nuestro botón estilizado de Google
  document.getElementById("googleCustom").addEventListener("click", (e) => {
    e.preventDefault();
    // Intentar mostrar el prompt de GSI (One Tap / selector)
    try {
      if(window.google && google.accounts && google.accounts.id && typeof google.accounts.id.prompt === 'function'){
        google.accounts.id.prompt(); // abrir selector/one-tap
      } else {
        // Si no está disponible, informar al usuario y abrir el botón renderizado oculto (fallback)
        showStatus("Atención", "El servicio de Google tardó en cargarse. Intentá nuevamente en un momento.");
      }
    } catch(err){
      console.error("GSI prompt error:", err);
      showStatus("Error", "No se pudo iniciar sesión con Google en este momento.");
    }
  });

  // Cerrar modales con Esc
  document.addEventListener('keydown', (e)=> {
    if(e.key === "Escape"){
      hideModal('modalEmail');
      hideModal('modalUnavailable');
      hideModal('modalStatus');
    }
  });
</script>
</body>
</html>



