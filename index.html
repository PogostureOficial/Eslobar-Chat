<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat con IA</title>
  <link rel="stylesheet" href="/static/index.css">
</head>
<body>

<!-- üîπ MEN√ö ESL0BAR -->
<div class="menu-container">
  <div class="menu-header" onclick="toggleMenu()">
    <span class="menu-title">Eslobar</span>
    <img src="/static/images/arrow.png" alt="arrow" class="menu-arrow">
  </div>
  <div class="menu-dropdown" id="dropdownMenu">
    
    <div class="menu-item" data-plan="basic" onclick="selectVersion('basic')">
      <img src="/static/images/basic.png" alt="Eslobar B√°sico" class="menu-icon">
      <div class="menu-text">
        <div class="menu-title-version">Eslobar</div>
        <div class="menu-description">Versi√≥n b√°sica. Con l√≠mite de preguntas y pocas materias.</div>
      </div>
      <span class="checkmark">‚úî</span>
    </div>

    <div class="menu-item" data-plan="plus" onclick="selectVersion('plus')">
      <img src="/static/images/plus.png" alt="Eslobar Plus" class="menu-icon">
      <div class="menu-text">
        <div class="menu-title-version">Eslobar Plus (La m√°s comprada)</div>
        <div class="menu-description">Versi√≥n avanzada. Explicaciones detalladas, m√°s materias y sin l√≠mite.</div>
      </div>
      <span class="checkmark">‚úî</span>
    </div>

    <div class="menu-item" data-plan="pro" onclick="selectVersion('pro')">
      <img src="/static/images/pro.png" alt="Eslobar Pro" class="menu-icon">
      <div class="menu-text">
        <div class="menu-title-version">Eslobar Pro</div>
        <div class="menu-description">Herramientas profesionales y acceso a todas las materias.</div>
      </div>
      <span class="checkmark">‚úî</span>
    </div>

  </div>
</div>


  <!-- T√≠tulo inicial -->
  <div id="titulo">¬øEn qu√© puedo ayudarte hoy?</div>

  <!-- Contenedor del chat -->
  <div id="chat" class="chat-box"></div>

  <!-- Entrada de texto y bot√≥n -->
  <div class="input-container" id="inputWrapper">
    <textarea 
      id="mensaje" 
      rows="1" 
      placeholder="Pregunta lo que quieras..." 
      onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault();enviarMensaje()}"
    ></textarea>

    <div class="voice-btn" id="voiceBtn" aria-hidden="true">
      <img src="/static/images/button1.png" id="btn1" class="initial-visible" alt="Micr√≥fono">
      <img src="/static/images/button2.png" id="btn2" class="initial-hidden" alt="Enviar">
    </div>
  </div>

  <!-- Archivo de configuraci√≥n: cambiar URL backend seg√∫n entorno -->
  <script src="/static/config.js"></script>

  <link rel="icon" type="image/png" href="/static/icon.png">

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>





  <script>
    
    /* =========================================================
       VARIABLES GLOBALES
    ========================================================= */
    const input = document.getElementById('mensaje');
    const chat = document.getElementById("chat");
    const titulo = document.getElementById("titulo");
    const btn1 = document.getElementById('btn1'); // mic
    const btn2 = document.getElementById('btn2'); // enviar

    let animBtn1 = null, animBtn2 = null;
    let previousHasText = false;
    const D = 250; // duraci√≥n animaciones
    const easing = 'cubic-bezier(.22,1,.36,1)';

    // BACKEND: usa CONFIG.BACKEND_URL si existe, si no -> '/ask'
const BACKEND_URL = (typeof CONFIG !== 'undefined' && CONFIG.BACKEND_URL) ? CONFIG.BACKEND_URL : '/ask';

    const menuArrow = document.querySelector('.menu-arrow');
const dropdownMenu = document.getElementById('dropdownMenu');

    /* =========================================================
       UTILIDADES
    ========================================================= */
    function parseBold(text) {
      return text.replace(/\*(.*?)\*/g, '<b>$1</b>');
    }

    function addBotMessage() {
      const botMsg = document.createElement("div");
      botMsg.className = "message bot";
      chat.appendChild(botMsg);
      return botMsg;
    }

    function typeWriterEffect(container, text = '', speed = 15) {
      return new Promise((resolve) => {
        if (!text) return resolve();
        const parsed = marked.parse(text);
        let i = 0;
        const interval = setInterval(() => {
          container.innerHTML = parsed.slice(0, i + 1);
          if (container.parentElement) {
            container.parentElement.scrollTop = container.parentElement.scrollHeight;
          }
          if (++i >= parsed.length) {
            clearInterval(interval);
            resolve();
          }
        }, speed);
      });
    }

    let selectedPlan = localStorage.getItem('selectedPlan') || 'basic';

function selectVersion(plan) {
  selectedPlan = plan;
  localStorage.setItem('selectedPlan', plan);
  updateSelectedPlanUI();

  // Cerrar men√∫ al seleccionar
  document.getElementById('dropdownMenu').style.display = 'none';
}

function updateSelectedPlanUI() {
  const items = document.querySelectorAll('.menu-item');
  items.forEach(item => {
    if (item.dataset.plan === selectedPlan) {
      item.classList.add('active');
    } else {
      item.classList.remove('active');
    }
  });
}

// üîπ Llamar al cargar la p√°gina para restaurar selecci√≥n
document.addEventListener('DOMContentLoaded', updateSelectedPlanUI);


    /* =========================================================
       ANIMACIONES BOTONES
    ========================================================= */
    function cancelAnimsAndFreeze() {
      [btn1, btn2].forEach((btn, idx) => {
        let anim = idx === 0 ? animBtn1 : animBtn2;
        if (anim) {
          anim.cancel();
          if (idx === 0) animBtn1 = null; else animBtn2 = null;
          const cs = getComputedStyle(btn);
          btn.style.transform = cs.transform === 'none' ? 'scale(1)' : cs.transform;
          btn.style.opacity = cs.opacity;
        }
      });
    }

    function transitionToBtn2() {
      cancelAnimsAndFreeze();
      btn1.style.visibility = 'visible';
      animBtn1 = btn1.animate(
        [{ transform: 'scale(1)', opacity: 1 }, { transform: 'scale(0)', opacity: 0 }],
        { duration: D, easing, fill: 'forwards' }
      );
      animBtn1.onfinish = () => {
        btn1.style.visibility = 'hidden';
        btn2.style.visibility = 'visible';
        animBtn2 = btn2.animate(
          [{ transform: 'scale(0)', opacity: 0 }, { transform: 'scale(1)', opacity: 1 }],
          { duration: D, easing, fill: 'forwards' }
        );
      };
    }

    function transitionToBtn1() {
      cancelAnimsAndFreeze();
      btn2.style.visibility = 'visible';
      animBtn2 = btn2.animate(
        [{ transform: 'scale(1)', opacity: 1 }, { transform: 'scale(0)', opacity: 0 }],
        { duration: D, easing, fill: 'forwards' }
      );
      animBtn2.onfinish = () => {
        btn2.style.visibility = 'hidden';
        btn1.style.visibility = 'visible';
        animBtn1 = btn1.animate(
          [{ transform: 'scale(0)', opacity: 0 }, { transform: 'scale(1)', opacity: 1 }],
          { duration: D, easing, fill: 'forwards' }
        );
      };
    }

    /* =========================================================
       EVENTOS
    ========================================================= */
    input.addEventListener('input', () => {
      const hasText = input.value.trim() !== '';
      if (hasText && !previousHasText) transitionToBtn2();
      else if (!hasText && previousHasText) transitionToBtn1();
      previousHasText = hasText;
      input.style.height = "auto";
      input.style.height = input.scrollHeight + "px";
      document.querySelector(".input-container")
        .classList.toggle("expanded", input.scrollHeight > input.clientHeight);
    });

    btn2.addEventListener("click", enviarMensaje);

    /* =========================================================
       MENSAJES
    ========================================================= */
    async function enviarMensaje() {
      const userText = input.value.trim();
      if (!userText) return;

      titulo.style.opacity = 0;
      const userMsg = document.createElement("div");
      userMsg.className = "message user";
      userMsg.innerHTML = parseBold(userText);
      chat.appendChild(userMsg);

      input.value = "";
      input.style.height = "auto";
      transitionToBtn1();
      previousHasText = false;

      const loadingMsg = document.createElement("div");
      loadingMsg.className = "message bot loading";
      loadingMsg.innerHTML = `<span></span>
        <video src="/static/videos/anim1.mp4" autoplay loop muted playsinline width="40"></video>`;
      chat.appendChild(loadingMsg);
      chat.scrollTop = chat.scrollHeight;

      // üîπ Fetch al backend (URL configurable en config.js)
      try {
        const resp = await fetch(BACKEND_URL, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    message: userText,
    plan: selectedPlan
  })
});


        const data = await resp.json();

        if (chat.contains(loadingMsg)) chat.removeChild(loadingMsg);
        const botMsg = addBotMessage();
        await typeWriterEffect(botMsg, data.reply || "‚ö†Ô∏è Error: sin respuesta.", 15);

      } catch (error) {
        if (chat.contains(loadingMsg)) chat.removeChild(loadingMsg);
        const botMsg = addBotMessage();
        await typeWriterEffect(botMsg, "‚ö†Ô∏è Error al conectar con el servidor.", 15);
      }
    }

     /* =========================================================
     UTILIDADES M√ìVILES: Ajustar altura din√°mica
  ========================================================= */
    </script>
<script>
(function() {
  // elementos (se buscan de nuevo para evitar dependencias de orden)
  const chat = document.getElementById('chat');
  const input = document.getElementById('mensaje');
  const inputWrapper = document.getElementById('inputWrapper');
  const titulo = document.getElementById('titulo');

  if (!chat || !input || !inputWrapper || !titulo) {
    // si falta algo, salimos sin romper la p√°gina
    console.warn('chat/ui elements missing for mobile-helper');
    return;
  }

  // Calcula y aplica la altura disponible al chat para que quede visible junto al teclado
  function ajustarAlturaMovil() {
    const vv = window.visualViewport;
    const viewportHeight = vv ? vv.height : window.innerHeight;
    const fullWindowInner = window.innerHeight;
    const inputH = inputWrapper.offsetHeight || 64;
    // deja un peque√±o margen para que no quede pegado (y espacio para safe-area)
    const margin = 10;
    const newMax = Math.max(120, Math.floor(viewportHeight - inputH - margin));

    // Aplicamos la altura m√°xima que el chat puede tener (permitimos scroll interno)
    chat.style.maxHeight = newMax + 'px';
    chat.style.overflowY = 'auto';

    // Determinar si consideramos "teclado abierto"
    // (si viewportHeight es significativamente menor que innerHeight)
    const keyboardProbablyOpen = vv ? (viewportHeight < fullWindowInner - 100) : false;

    if (keyboardProbablyOpen) {
      // bloquear scroll del body/p√°gina para que no te muevas con barras; solo el chat scrolla
      document.body.style.overflow = 'hidden';
      // algunos navegadores requieren fijar la altura para evitar saltos; establecemos una altura expl√≠cita
      document.documentElement.style.height = (viewportHeight) + 'px';
      document.body.style.height = (viewportHeight) + 'px';
    } else {
      // restaurar comportamiento normal
      document.body.style.overflow = '';
      document.documentElement.style.height = '';
      document.body.style.height = '';
      // fallback: si hay muchos mensajes, dejar que el chat tenga cierto max (desktop-like)
      chat.style.maxHeight = '';
    }

    // si hay mensajes, ocultar t√≠tulo; si no, mostrar
    const hasMessages = !!chat.querySelector('.message');
    titulo.style.transition = 'opacity 0.18s ease';
    titulo.style.opacity = hasMessages ? '0' : '1';

    // asegurarnos de que el √∫ltimo mensaje sea visible
    chat.scrollTop = chat.scrollHeight;
  }

  // Llamadas a listeners: visualViewport (mejor) y fallback resize
  if (window.visualViewport) {
    window.visualViewport.addEventListener('resize', ajustarAlturaMovil);
    window.visualViewport.addEventListener('scroll', ajustarAlturaMovil);
  }
  window.addEventListener('resize', ajustarAlturaMovil);

  // Auto-grow del textarea (ya tienes algo parecido; esto refuerza)
  function autoGrow() {
    input.style.height = 'auto';
    input.style.height = input.scrollHeight + 'px';
    ajustarAlturaMovil();
  }
  input.addEventListener('input', autoGrow);

  // Al hacer focus en el input: forzamos recalculo y scroll para que no quede tapado
  input.addEventListener('focus', () => {
    setTimeout(() => {
      ajustarAlturaMovil();
      input.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
    }, 80);
  });

  // Al hacer blur (se cierra teclado): restaurar
  input.addEventListener('blur', () => {
    setTimeout(ajustarAlturaMovil, 80);
  });

  // Inicializaci√≥n
  window.addEventListener('load', () => {
    autoGrow();
    ajustarAlturaMovil();
  });

  // Exponer helper para tu flujo: si insertas mensajes manualmente, llama esto
  window.__mobileChatHelpers = {
    recalc: ajustarAlturaMovil,
    scrollToBottom: () => { chat.scrollTop = chat.scrollHeight; }
  };
})();
</script>
  
    <script>
  // Toggle menu
function toggleMenu() {
  const showing = dropdownMenu.style.display === 'block';
  dropdownMenu.style.display = showing ? 'none' : 'block';
  if (menuArrow) menuArrow.style.transform = showing ? 'rotate(0deg)' : 'rotate(180deg)';
}

// Cerrar si se hace clic fuera del men√∫ (pero no si se hace click dentro)
document.addEventListener('click', function(e) {
  const menuContainer = document.querySelector('.menu-container');
  if (menuContainer && !menuContainer.contains(e.target)) {
    dropdownMenu.style.display = 'none';
    if (menuArrow) menuArrow.style.transform = 'rotate(0deg)';
  }
});

</script>
</body>
</html>










